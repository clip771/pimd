<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel de Acessos Registrados</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body.dark-mode {
      background-color: #121212;
      color: #f1f1f1;
    }
    body.dark-mode .table {
      background-color: #1e1e1e;
      color: #f1f1f1;
    }
    body.dark-mode .table thead {
      background-color: #2a2a2a;
      color: #f1f1f1;
    }
    body.dark-mode .table-striped tbody tr:nth-of-type(odd) {
      background-color: #2a2a2a;
    }
    body.dark-mode .table-striped tbody tr:nth-of-type(even) {
      background-color: #1e1e1e;
    }
    body.dark-mode input,
    body.dark-mode select {
      background-color: #2a2a2a !important;
      color: #f1f1f1 !important;
      border: 1px solid #444 !important;
    }
    body.dark-mode .card {
      background-color: #1e1e1e;
      color: #f1f1f1;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1>Acessos Registrados</h1>
      <button id="darkModeToggle" class="btn btn-dark">Ativar/Desativar Modo Escuro</button>
    </div>

    <button id="limparBtn" class="btn btn-danger mb-3">Limpar Acessos</button>
    <button id="refreshBtn" class="btn btn-secondary mb-3 ms-2">Atualizar Lista</button>

    <div class="table-responsive mb-4">
      <table class="table table-striped table-bordered" id="accessTable">
        <thead>
          <tr>
            <th>#</th>
            <th>IP</th>
            <th>Data e Hora</th>
          </tr>
        </thead>
        <tbody id="accessTableBody">
          <tr><td colspan="3">Carregando...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="row g-3">
      <div class="col-md-4">
        <div class="card p-3">
          <h5>Total de Acessos</h5>
          <div id="totalAcessos">0</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3">
          <h5>Países Únicos</h5>
          <div id="uniqueCountries">0</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3">
          <h5>Acessos por Hora (Últimas 24h)</h5>
          <div id="accessesPerHour">0</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let acessos = [];

    async function carregarAcessos() {
      const tbody = document.getElementById('accessTableBody');
      tbody.innerHTML = '<tr><td colspan="3">Carregando...</td></tr>';

      try {
        const res = await fetch('/.netlify/functions/listar-online');
        const data = await res.json();

        if (!data.success) {
          tbody.innerHTML = `<tr><td colspan="3" class="text-danger">Erro: ${data.error}</td></tr>`;
          return;
        }

        acessos = data.acessos || [];

        if (acessos.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3">Nenhum acesso registrado.</td></tr>';
        } else {
          tbody.innerHTML = '';
          acessos.forEach((acesso, index) => {
            const date = new Date(acesso.timestamp);
            const row = `
              <tr>
                <td>${index + 1}</td>
                <td>${acesso.ip}</td>
                <td>${date.toLocaleString('pt-BR')}</td>
              </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
          });
        }

        atualizarEstatisticas();
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="3" class="text-danger">Erro ao carregar dados.</td></tr>`;
        console.error(err);
      }
    }

    function atualizarEstatisticas() {
      document.getElementById('totalAcessos').textContent = acessos.length;

      const countries = new Set();
      const now = Date.now();
      let last24h = 0;

      acessos.forEach(a => {
        if (a.country) countries.add(a.country);
        if (now - new Date(a.timestamp).getTime() <= 24 * 60 * 60 * 1000) {
          last24h++;
        }
      });

      document.getElementById('uniqueCountries').textContent = countries.size;
      document.getElementById('accessesPerHour').textContent = last24h;
    }

    async function limparAcessos() {
      if (!confirm('Tem certeza que deseja limpar TODOS os acessos?')) return;

      try {
        const res = await fetch('/.netlify/functions/limpar-online', { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          alert('Acessos limpos com sucesso!');
          carregarAcessos();
        } else {
          alert(`Erro: ${data.error}`);
        }
      } catch (err) {
        alert('Erro na requisição.');
        console.error(err);
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', carregarAcessos);
    document.getElementById('limparBtn').addEventListener('click', limparAcessos);

    const darkModeToggle = document.getElementById('darkModeToggle');
    darkModeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
    });

    carregarAcessos();
  </script>
</body>
</html>
