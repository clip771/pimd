<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Acessos Registrados - Painel Completo</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Modo escuro */
    body.dark-mode {
      background-color: #121212 !important;
      color: #eee;
    }
    body.dark-mode .table {
      color: #eee;
    }
    body.dark-mode .table-striped>tbody>tr:nth-of-type(odd) {
      --bs-table-accent-bg: #2c2c2c;
    }
    body.dark-mode .btn {
      border-color: #444;
    }
    body.dark-mode .btn-danger {
      background-color: #b34747;
      border-color: #b34747;
    }
    body.dark-mode .btn-secondary {
      background-color: #444;
      border-color: #444;
      color: #eee;
    }
    body.dark-mode .form-control {
      background-color: #222;
      color: #eee;
      border-color: #444;
    }
    body.dark-mode .form-control::placeholder {
      color: #aaa;
    }
    body.dark-mode .page-link {
      background-color: #222;
      color: #eee;
      border-color: #444;
    }

    /* Layout extras */
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1100;
    }
    .cursor-pointer {
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
      <h1>Acessos Registrados</h1>
      <div>
        <button id="toggleDarkBtn" class="btn btn-outline-dark me-2">Modo Escuro</button>
        <button id="refreshBtn" class="btn btn-secondary me-2">Atualizar Lista</button>
        <button id="limparBtn" class="btn btn-danger">Limpar Acessos</button>
      </div>
    </div>

    <div class="row mb-3 gy-2 gx-3 align-items-center">
      <div class="col-auto">
        <input id="searchInput" type="search" class="form-control" placeholder="Buscar IP..." />
      </div>
      <div class="col-auto">
        <label for="pageSizeSelect" class="form-label mb-0">Itens por página:</label>
        <select id="pageSizeSelect" class="form-select">
          <option value="10" selected>10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
    </div>

    <!-- Estatísticas -->
    <div id="stats" class="mb-4 row text-center text-md-start">
      <div class="col-6 col-md-3 mb-2">
        <div class="border rounded p-3 bg-white shadow-sm dark-mode-bg">
          <h5>Total de acessos</h5>
          <strong id="totalAccess">0</strong>
        </div>
      </div>
      <div class="col-6 col-md-3 mb-2">
        <div class="border rounded p-3 bg-white shadow-sm dark-mode-bg">
          <h5>Países únicos</h5>
          <strong id="uniqueCountries">0</strong>
        </div>
      </div>
      <div class="col-12 col-md-6 mb-2">
        <div class="border rounded p-3 bg-white shadow-sm dark-mode-bg">
          <h5>Acessos por hora (últimas 24h)</h5>
          <canvas id="chartAccessHour" height="100"></canvas>
        </div>
      </div>
    </div>

    <!-- Tabela -->
    <div class="table-responsive">
      <table class="table table-striped table-bordered align-middle">
        <thead>
          <tr>
            <th>#</th>
            <th>IP</th>
            <th>Data e Hora</th>
            <th>País</th>
          </tr>
        </thead>
        <tbody id="accessTableBody">
          <tr><td colspan="4">Carregando...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Paginação -->
    <nav>
      <ul id="pagination" class="pagination justify-content-center"></ul>
    </nav>

    <!-- Exportar CSV -->
    <div class="d-flex justify-content-end mb-4">
      <button id="exportCsvBtn" class="btn btn-outline-primary">Exportar CSV</button>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    // Estado global
    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    let pageSize = 10;
    let chartInstance = null;

    // Referências DOM
    const tbody = document.getElementById('accessTableBody');
    const pagination = document.getElementById('pagination');
    const searchInput = document.getElementById('searchInput');
    const pageSizeSelect = document.getElementById('pageSizeSelect');
    const totalAccessEl = document.getElementById('totalAccess');
    const uniqueCountriesEl = document.getElementById('uniqueCountries');
    const toggleDarkBtn = document.getElementById('toggleDarkBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const limparBtn = document.getElementById('limparBtn');
    const refreshBtn = document.getElementById('refreshBtn');

    // Funções utilitárias

    // Mostrar toast
    function showToast(message, type = 'info', duration = 3000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Fechar"></button>
        </div>
      `;
      container.appendChild(toast);

      toast.querySelector('button').addEventListener('click', () => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => toast.remove());
      });

      setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => toast.remove());
      }, duration);
    }

    // Aplicar modo escuro salvo
    function applySavedMode() {
      if(sessionStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        toggleDarkBtn.textContent = 'Modo Claro';
        toggleDarkBtn.classList.remove('btn-outline-dark');
        toggleDarkBtn.classList.add('btn-light');
      }
    }

    // Alternar modo escuro
    function toggleDarkMode() {
      const body = document.body;
      body.classList.toggle('dark-mode');
      if(body.classList.contains('dark-mode')) {
        sessionStorage.setItem('darkMode', 'true');
        toggleDarkBtn.textContent = 'Modo Claro';
        toggleDarkBtn.classList.remove('btn-outline-dark');
        toggleDarkBtn.classList.add('btn-light');
      } else {
        sessionStorage.removeItem('darkMode');
        toggleDarkBtn.textContent = 'Modo Escuro';
        toggleDarkBtn.classList.remove('btn-light');
        toggleDarkBtn.classList.add('btn-outline-dark');
      }
    }

    // Render tabela com paginação
    function renderTable() {
      const start = (currentPage -1)*pageSize;
      const end = start + pageSize;
      const pageData = filteredData.slice(start, end);

      tbody.innerHTML = '';

      if(pageData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum acesso encontrado.</td></tr>';
        return;
      }

      pageData.forEach(({index, ip, date, country}) => {
        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${index}</td>
            <td>${ip}</td>
            <td>${date.toLocaleString('pt-BR')}</td>
            <td>${country}</td>
          </tr>
        `);
      });

      renderPagination();
    }

    // Render paginação
    function renderPagination() {
      pagination.innerHTML = '';
      const totalPages = Math.ceil(filteredData.length / pageSize);
      if(totalPages <= 1) return;

      function createPageItem(num, active = false) {
        const li = document.createElement('li');
        li.className = `page-item ${active ? 'active' : ''}`;
        const a = document.createElement('a');
        a.className = 'page-link cursor-pointer';
        a.textContent = num;
        a.addEventListener('click', () => {
          if(currentPage !== num) {
            currentPage = num;
            renderTable();
          }
        });
        li.appendChild(a);
        return li;
      }

      // Prev
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      const prevA = document.createElement('a');
      prevA.className = 'page-link cursor-pointer';
      prevA.textContent = 'Anterior';
      prevA.addEventListener('click', () => {
        if(currentPage > 1) {
          currentPage--;
          renderTable();
        }
      });
      prevLi.appendChild(prevA);
      pagination.appendChild(prevLi);

      // Páginas (mostrar no máximo 7)
      let startPage = Math.max(1, currentPage - 3);
      let endPage = Math.min(Math.ceil(filteredData.length / pageSize), currentPage + 3);

      // Ajusta se estiver perto do início/fim
      if(currentPage <= 4) endPage = Math.min(7, Math.ceil(filteredData.length / pageSize));
      if(currentPage > Math.ceil(filteredData.length / pageSize) - 4) startPage = Math.max(1, Math.ceil(filteredData.length / pageSize) - 6);

      for(let i = startPage; i <= endPage; i++) {
        pagination.appendChild(createPageItem(i, i === currentPage));
      }

      // Next
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentPage === Math.ceil(filteredData.length / pageSize) ? 'disabled' : ''}`;
      const nextA = document.createElement('a');
      nextA.className = 'page-link cursor-pointer';
      nextA.textContent = 'Próximo';
      nextA.addEventListener('click', () => {
        if(currentPage < Math.ceil(filteredData.length / pageSize)) {
          currentPage++;
          renderTable();
        }
      });
      nextLi.appendChild(nextA);
      pagination.appendChild(nextLi);
    }

    // Atualizar estatísticas
    function updateStats() {
      totalAccessEl.textContent = allData.length;

      const countriesSet = new Set(allData.map(a => a.country));
      uniqueCountriesEl.textContent = countriesSet.size;

      // Acessos por hora últimas 24h
      const now = new Date();
      const hoursArr = Array(24).fill(0);
      allData.forEach(({date}) => {
        const diffHours = Math.floor((now - date) / (1000*60*60));
        if(diffHours >= 0 && diffHours < 24) {
          hoursArr[23 - diffHours]++;
        }
      });

      renderChart(hoursArr);
    }

    // Render gráfico com Chart.js
    function renderChart(data) {
      const ctx = document.getElementById('chartAccessHour').getContext('2d');

      if(chartInstance) {
        chartInstance.data.datasets[0].data = data;
        chartInstance.update();
        return;
      }

      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Array.from({length:24}, (_, i) => {
            const h = (new Date()).getHours() - 23 + i;
            return ((h + 24) % 24) + ':00';
          }),
          datasets: [{
            label: 'Acessos',
            data: data,
            backgroundColor: '#0d6efd'
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    // Filtrar dados pela busca
    function filterData() {
      const query = searchInput.value.trim().toLowerCase();
      if(query === '') {
        filteredData = allData;
      } else {
        filteredData = allData.filter(a => a.ip.toLowerCase().includes(query));
      }
      currentPage = 1;
      renderTable();
    }

    // Exportar CSV
    function exportCSV() {
      if(filteredData.length === 0) {
        showToast('Nada para exportar.', 'warning');
        return;
      }
      const rows = [
        ['#', 'IP', 'Data e Hora', 'País'],
        ...filteredData.map(({index, ip, date, country}) => [
          index,
          ip,
          date.toLocaleString('pt-BR'),
          country
        ])
      ];

      const csvContent = rows.map(e => e.map(cell => `"${cell}"`).join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'acessos.csv';
      a.click();

      URL.revokeObjectURL(url);
    }

    // Função principal para carregar dados da API
    async function carregarAcessos() {
      tbody.innerHTML = '<tr><td colspan="4">Carregando...</td></tr>';
      try {
        const res = await fetch('/.netlify/functions/listar-online');
        const data = await res.json();

        if(!data.success) {
          tbody.innerHTML = `<tr><td colspan="4" class="text-danger">Erro: ${data.error || 'Erro desconhecido'}</td></tr>`;
          showToast('Erro ao carregar dados.', 'danger');
          return;
        }

        // Processar dados
        allData = (data.acessos || []).map((item, i) => ({
          index: i+1,
          ip: item.ip,
          date: new Date(item.timestamp),
          country: item.country || 'N/D'  // seu endpoint deve retornar país
        }));

        filteredData = allData;

        updateStats();
        filterData(); // render com filtro vazio = tudo
      } catch(err) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-danger">Erro ao carregar dados.</td></tr>`;
        showToast('Erro na requisição.', 'danger');
        console.error(err);
      }
    }

    // Limpar acessos
    async function limparAcessos() {
      if(!confirm('Tem certeza que deseja limpar TODOS os acessos?')) return;

      try {
        const res = await fetch('/.netlify/functions/limpar-online', { method: 'POST' });
        const data = await res.json();

        if(data.success) {
          showToast('Acessos limpos com sucesso!', 'success');
          carregarAcessos();
        } else {
          showToast(`Erro: ${data.error || 'Erro desconhecido'}`, 'danger');
        }
      } catch(err) {
        showToast('Erro na requisição.', 'danger');
        console.error(err);
      }
    }

    // Eventos
    searchInput.addEventListener('input', filterData);
    pageSizeSelect.addEventListener('change', () => {
      pageSize = Number(pageSizeSelect.value);
      currentPage = 1;
      renderTable();
    });
    toggleDarkBtn.addEventListener('click', toggleDarkMode);
    exportCsvBtn.addEventListener('click', exportCSV);
    limparBtn.addEventListener('click', limparAcessos);
    refreshBtn.addEventListener('click', carregarAcessos);

    // Inicialização
    applySavedMode();
    carregarAcessos();
  </script>

  <!-- Bootstrap JS Bundle (Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
