<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Acessos Registrados</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body.dark-mode {
      background-color: #000 !important;
      color: #eee !important;
      min-height: 100vh;
    }
    body.dark-mode .container {
      background-color: #000 !important;
      color: #eee !important;
      min-height: 100vh;
      padding-bottom: 3rem;
    }
    body.dark-mode .btn {
      border-color: #eee !important;
      color: #eee !important;
      background-color: #222 !important;
    }
    body.dark-mode .btn:hover {
      background-color: #444 !important;
      color: #fff !important;
    }
    /* Tabela e células no modo escuro */
    body.dark-mode table,
    body.dark-mode table > :not(caption) > * > * {
      background-color: #000 !important;
      color: #eee !important;
      border-color: #555 !important;
    }
    /* Cards estatísticos */
    .stats-cards {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }
    .stats-card {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 1rem 1.5rem;
      flex: 1;
      min-width: 180px;
      box-shadow: 0 0 8px rgb(0 0 0 / 0.1);
      text-align: center;
      color: #222;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode .stats-card {
      background-color: #222 !important;
      color: #eee !important;
      box-shadow: 0 0 8px rgb(255 255 255 / 0.15) !important;
    }
    /* Gráfico */
    #accessChart {
      max-width: 100%;
      margin-top: 1rem;
    }
    /* Inputs no modo escuro */
    body.dark-mode input.form-control,
    body.dark-mode select.form-select {
      background-color: #222 !important;
      color: #eee !important;
      border-color: #555 !important;
    }
    body.dark-mode input.form-control::placeholder {
      color: #bbb !important;
    }
    /* Toast de feedback */
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1055;
    }
    .toast {
      background-color: #333;
      color: #eee;
    }
    body.dark-mode .toast {
      background-color: #444;
      color: #eee;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h1 class="mb-4">Acessos Registrados</h1>

    <div class="mb-3 d-flex flex-wrap align-items-center gap-2">
      <button id="limparBtn" class="btn btn-danger">Limpar Acessos</button>
      <button id="refreshBtn" class="btn btn-secondary ms-1">Atualizar Lista</button>
      <button id="exportCsvBtn" class="btn btn-success ms-1">Exportar CSV</button>
      <button id="toggleDarkBtn" class="btn btn-outline-dark ms-1">Modo Escuro</button>

      <input type="text" id="searchInput" class="form-control ms-auto" placeholder="Buscar IP..." style="max-width: 250px;" />

      <select id="pageSizeSelect" class="form-select ms-2" aria-label="Tamanho da página">
        <option value="5">5 por página</option>
        <option value="10" selected>10 por página</option>
        <option value="25">25 por página</option>
        <option value="50">50 por página</option>
      </select>
    </div>

    <table class="table table-striped table-bordered mt-3" id="accessTable">
      <thead>
        <tr>
          <th>#</th>
          <th>IP</th>
          <th>Data e Hora</th>
          <th>País</th>
        </tr>
      </thead>
      <tbody id="accessTableBody">
        <tr><td colspan="4">Carregando...</td></tr>
      </tbody>
    </table>

    <nav aria-label="Paginação">
      <ul id="pagination" class="pagination justify-content-center"></ul>
    </nav>

    <div class="stats-cards">
      <div class="stats-card">
        <h5>Total de acessos</h5>
        <p id="totalAccesses" class="fs-3 mb-0">0</p>
      </div>
      <div class="stats-card">
        <h5>Países únicos</h5>
        <p id="uniqueCountries" class="fs-3 mb-0">0</p>
      </div>
      <div class="stats-card">
        <h5>Acessos por hora (últimas 24h)</h5>
        <canvas id="accessChart" height="100"></canvas>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-container position-fixed top-0 end-0 p-3"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const tbody = document.getElementById('accessTableBody');
    const limparBtn = document.getElementById('limparBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const toggleDarkBtn = document.getElementById('toggleDarkBtn');
    const searchInput = document.getElementById('searchInput');
    const pageSizeSelect = document.getElementById('pageSizeSelect');
    const pagination = document.getElementById('pagination');
    const totalAccessesElem = document.getElementById('totalAccesses');
    const uniqueCountriesElem = document.getElementById('uniqueCountries');
    const accessChartCtx = document.getElementById('accessChart').getContext('2d');

    let acessos = [];
    let filteredData = [];
    let currentPage = 1;
    let pageSize = Number(pageSizeSelect.value);
    let chart = null;

    // Toast helper
    function showToast(message, duration = 3000) {
      const container = document.querySelector('.toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast align-items-center show';
      toast.role = 'alert';
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close"></button>
        </div>`;
      container.appendChild(toast);
      toast.querySelector('button').onclick = () => toast.remove();
      setTimeout(() => toast.remove(), duration);
    }

    async function carregarAcessos() {
      tbody.innerHTML = '<tr><td colspan="4">Carregando...</td></tr>';
      try {
        const res = await fetch('/.netlify/functions/listar-online');
        const data = await res.json();

        if (!data.success) {
          tbody.innerHTML = `<tr><td colspan="4" class="text-danger">Erro: ${data.error}</td></tr>`;
          return;
        }

        acessos = data.acessos || [];

        if (acessos.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4">Nenhum acesso registrado.</td></tr>';
        }

        currentPage = 1;
        filteredData = [...acessos];

        renderTable();
        renderStats();
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-danger">Erro ao carregar dados.</td></tr>`;
        console.error(err);
      }
    }

    function renderTable() {
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageData = filteredData.slice(start, end);

      tbody.innerHTML = '';
      if (pageData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4">Nenhum dado encontrado.</td></tr>';
        renderPagination();
        return;
      }

      pageData.forEach((acesso, index) => {
        const date = new Date(acesso.timestamp);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${start + index + 1}</td>
          <td>${acesso.ip}</td>
          <td>${date.toLocaleString('pt-BR')}</td>
          <td>${acesso.country || '—'}</td>
        `;
        tbody.appendChild(row);
      });

      renderPagination();
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredData.length / pageSize);
      pagination.innerHTML = '';

      if (totalPages <= 1) return;

      const prevLi = document.createElement('li');
      prevLi.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
      prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Anterior">&laquo;</a>`;
      prevLi.onclick = e => {
        e.preventDefault();
        if (currentPage > 1) {
          currentPage--;
          renderTable();
        }
      };
      pagination.appendChild(prevLi);

      const maxPagesToShow = 7;
      let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
      let endPage = startPage + maxPagesToShow - 1;
      if (endPage > totalPages) {
        endPage = totalPages;
        startPage = Math.max(1, endPage - maxPagesToShow + 1);
      }

      for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = 'page-item' + (i === currentPage ? ' active' : '');
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.onclick = e => {
          e.preventDefault();
          currentPage = i;
          renderTable();
        };
        pagination.appendChild(li);
      }

      const nextLi = document.createElement('li');
      nextLi.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
      nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Próximo">&raquo;</a>`;
      nextLi.onclick = e => {
        e.preventDefault();
        if (currentPage < totalPages) {
          currentPage++;
          renderTable();
        }
      };
      pagination.appendChild(nextLi);
    }

    function renderStats() {
      totalAccessesElem.textContent = acessos.length;
      const countries = new Set(acessos.map(a => a.country).filter(c => c));
      uniqueCountriesElem.textContent = countries.size;

      const now = new Date();
      const hoursLabels = [];
      const accessesPerHour = [];

      for (let i = 23; i >= 0; i--) {
        const hourDate = new Date(now);
        hourDate.setHours(now.getHours() - i, 0, 0, 0);
        hoursLabels.push(hourDate.getHours().toString().padStart(2, '0') + ':00');
        accessesPerHour.push(0);
      }

      acessos.forEach(acesso => {
        const dt = new Date(acesso.timestamp);
        const diff = (now - dt) / (1000 * 60 * 60);
        if (diff >= 0 && diff < 24) {
          const index = 23 - Math.floor(diff);
          accessesPerHour[index]++;
        }
      });

      if (chart) chart.destroy();
      chart = new Chart(accessChartCtx, {
        type: 'bar',
        data: {
          labels: hoursLabels,
          datasets: [{
            label: 'Acessos',
            data: accessesPerHour,
            backgroundColor: 'rgba(100, 149, 237, 0.7)',
            borderColor: 'rgba(100, 149, 237, 1)',
            borderWidth: 1,
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          },
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true }
          }
        }
      });
    }

    limparBtn.onclick = async () => {
      if (!confirm('Tem certeza que deseja limpar todos os acessos?')) return;
      try {
        const res = await fetch('/.netlify/functions/limpar-acessos', { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          acessos = [];
          filteredData = [];
          currentPage = 1;
          renderTable();
          renderStats();
          showToast('Acessos limpos com sucesso!');
        } else {
          showToast('Erro ao limpar acessos: ' + (data.error || 'Desconhecido'));
        }
      } catch (e) {
        showToast('Erro na requisição ao limpar acessos.');
      }
    };

    refreshBtn.onclick = () => carregarAcessos();

    exportCsvBtn.onclick = () => {
      if (acessos.length === 0) {
        showToast('Não há dados para exportar.');
        return;
      }

      const headers = ['#', 'IP', 'Data e Hora', 'País'];
      const rows = acessos.map((a, i) => [
        i + 1,
        a.ip,
        new Date(a.timestamp).toLocaleString('pt-BR'),
        a.country || ''
      ]);

      let csvContent = 'data:text/csv;charset=utf-8,';
      csvContent += headers.join(';') + '\n';
      rows.forEach(row => {
        csvContent += row.map(field => `"${field}"`).join(';') + '\n';
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', 'acessos.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    toggleDarkBtn.onclick = () => {
      const isDark = document.body.classList.toggle('dark-mode');
      document.body.classList.toggle('bg-light', !isDark);
      toggleDarkBtn.textContent = isDark ? 'Modo Claro' : 'Modo Escuro';
    };

    searchInput.oninput = () => {
      const term = searchInput.value.trim().toLowerCase();
      if (term === '') {
        filteredData = [...acessos];
      } else {
        filteredData = acessos.filter(a => a.ip.toLowerCase().includes(term));
      }
      currentPage = 1;
      renderTable();
    };

    pageSizeSelect.onchange = () => {
      pageSize = Number(pageSizeSelect.value);
      currentPage = 1;
      renderTable();
    };

    carregarAcessos();
  </script>
</body>
</html>
